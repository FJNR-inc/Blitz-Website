<app-loader *ngIf="!profile"></app-loader>

<div class="profile-page" *ngIf="profile">
  <h1 class="profile-page__title">
    Bonjour {{ profile.first_name }},
  </h1>

  <div class="profile-page__content">
    <div class="profile-page__content__left">
      <h2 class="profile-page__sub-title">
        Informations personnelles
      </h2>

      <form (submit)="submitProfile()" [formGroup]="userForm" *ngIf="userForm">
        <div *ngFor="let error of errors" class="alert alert--danger">
          {{ error }}
        </div>

        <div class="form-group">
          <label for="first_name" class="nt-form-label">Nom:</label>
          <input formControlName="first_name" class="nt-form-input" id="first_name" type="text">
          <div class="form-text form-text--right form-text--danger"
               *ngFor="let errorMessage of userForm.controls['first_name'].getError('apiError')">
            {{ errorMessage}}
          </div>
        </div>
        <div class="form-group">
          <label for="last_name" class="nt-form-label">Prenom:</label>
          <input formControlName="last_name" class="nt-form-input" id="last_name" type="text">
          <div class="form-text form-text--right form-text--danger"
               *ngFor="let errorMessage of userForm.controls['last_name'].getError('apiError')">
            {{ errorMessage}}
          </div>
        </div>
        <div class="form-group">
          <label for="birthdate" class="nt-form-label">Date de naissance:</label>
          <input [owlDateTimeTrigger]="dt_end"
                 [owlDateTime]="dt_end"
                 formControlName="birthdate"
                 class="nt-form-input"
                 id="birthdate">
          <owl-date-time #dt_end [firstDayOfWeek]="1" pickerType="calendar"></owl-date-time>
          <div class="form-text form-text--right form-text--danger"
               *ngFor="let errorMessage of userForm.controls['birthdate'].getError('apiError')">
            {{ errorMessage}}
          </div>
        </div>
        <div class="form-group">
          <label for="gender" class="nt-form-label">Genre:</label>
          <select formControlName="gender" id="gender" class="nt-form-input">
            <option value="A">Je ne souhaite pas m'identifie</option>
            <option value="M">Homme</option>
            <option value="F">Femme</option>
            <option value="T">Trans</option>
          </select>
          <div class="form-text form-text--right form-text--danger"
               *ngFor="let errorMessage of userForm.controls['gender'].getError('apiError')">
            {{ errorMessage}}
          </div>
        </div>
        <button type="submit" class="nt-button">Sauvegarder</button>
      </form>

      <h2 class="profile-page__sub-title">
        Abonnement
      </h2>

      <div class="profile-page__content__left__box" *ngIf="profile.membership">
        <p class="profile-page__content__left__box__text">
          {{ profile.membership.name }}
        </p>
        <p class="profile-page__content__left__box__sub-text">
          {{ profile.membership.price }}$ / année
        </p>
      </div>
      <div class="profile-page__content__left__box" *ngIf="!profile.membership">
        <p class="profile-page__content__left__box__text">
          Aucun abonnement
        </p>
        <p class="profile-page__content__left__box__sub-text">
          <a class="nt-link" routerLink="/membership/intro">Devenez membre</a>
        </p>
      </div>

      <h2 class="profile-page__sub-title">
        Mode de paiement
      </h2>

      <div class="profile-page__content__left__cards" *ngIf="listCards && listCards.length">
        <div class="profile-page__content__left__cards__card" *ngFor="let card of listCards">
          <div class="profile-page__content__left__cards__card__title">
            Numéro de carte
          </div>
          <div class="profile-page__content__left__cards__card__number">
            **** **** **** {{ card.last_digits }}
          </div>
          <div class="profile-page__content__left__cards__card__bottom">
            <div>
              <div class="profile-page__content__left__cards__card__title">
                Date d'expiration
              </div>
              <div class="profile-page__content__left__cards__card__number">
                {{ card.card_expiry.month }} / {{ card.card_expiry.year }}
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="profile-page__content__left__cards" *ngIf="!listCards || listCards && !listCards.length">
        <div class="profile-page__content__left__cards__card">
          <div class="profile-page__content__left__cards__card__title">
            Aucun mode de paiement pourt le moment
          </div>
        </div>
      </div>

      <h2 class="profile-page__sub-title">
        Désactivation
      </h2>

      <div class="profile-page__content__left__account">
        <div class="profile-page__content__left__account__content">
          <p>Si vous désactivez votre profil:</p>
          <ul>
            <li>Vous ne pourrez plus vous connecter sur ce site</li>
            <li>Vos réservations seront annulées automatiquement</li>
            <li>Certaines de vos informations personnelles pourraient être supprimés</li>
          </ul>

          <a class="nt-link profile-page__content__left__account__content__link" appMyModalOpen='form_deactivate_account'>
            Désactiver mon profil
          </a>
        </div>
      </div>
    </div>
    <div class="profile-page__content__right">
      <div class="profile-page__content__right__top">
        <div class="profile-page__content__right__top__box">
          <p class="profile-page__content__right__top__box__number">
            {{ profile.tickets}}
          </p>
          <div class="profile-page__content__right__top__box__text">
            bloc(s) prépayé(s)
          </div>
          <p class="profile-page__content__right__top__box__sub-text">
            pour réserver à l'Espace
          </p>
        </div>
        <div class="profile-page__content__right__top__box profile-page__content__right__top__box--main">
          <p class="profile-page__content__right__top__box__number">
            {{ profile.getTimeBeforeEndMembership() }}
          </p>
          <div class="profile-page__content__right__top__box__text">
            jour(s) restant(s)
          </div>
          <p class="profile-page__content__right__top__box__sub-text">
            à votre membership
          </p>
        </div>
      </div>
      <div class="profile-page__content__right__stats">
        <div class="profile-page__content__right__stats__done">
          <p class="profile-page__content__right__stats__done__number">
            {{totalPastReservations}}
            <img src="../../../../assets/images/icons/icon_tomato.svg" class="profile-page__content__right__stats__done__number__icon"/>
          </p>
          <p class="profile-page__content__right__stats__done__text">
            Accomplie(s)
          </p>
          <p class="profile-page__content__right__stats__done__sub-text">
            jusqu'à maintenant
          </p>
        </div>
        <div class="profile-page__content__right__stats__future">
          <p class="profile-page__content__right__stats__future__number">
            {{totalFutureReservations}}
            <img src="../../../../assets/images/icons/icon_tomato.svg" class="profile-page__content__right__stats__future__number__icon"/>
          </p>
          <p class="profile-page__content__right__stats__future__text">
            Prévue(s)
          </p>
          <p class="profile-page__content__right__stats__future__sub-text">
            à votre horaire
          </p>
        </div>
      </div>
      <div class="profile-page__content__right__blocs">
        <h2 class="profile-page__sub-title">
          Mes blocs de rédaction
        </h2>

        <table class="profile-page__content__right__blocs__table">
          <thead class="profile-page__content__right__blocs__table__header">
            <tr>
              <th>
                Date
              </th>
              <th>
                Espace
              </th>
              <th>
                Heures
              </th>
              <th>
                <img src="../../../../assets/images/icons/icon_tomato.svg" class="profile-page__content__right__blocs__table__header__icon" />
              </th>
              <th>
                Annuler
              </th>
            </tr>
          </thead>
          <tbody *ngIf="getDisplayedReservation()" class="profile-page__content__right__blocs__table__body">
            <tr *ngFor="let reservation of getDisplayedReservation()">
              <td>
                {{reservation.timeslot_details.getStartDay()}}
              </td>
              <td>
                <p>
                  {{reservation.timeslot_details.workplace.name}}
                </p>
                {{reservation.timeslot_details.workplace.address_line1}}<br/>
                <span *ngIf="reservation.timeslot_details.workplace.address_line2">
                  {{reservation.timeslot_details.workplace.address_line2}}<br/>
                </span>
                {{reservation.timeslot_details.workplace.city}}, {{reservation.timeslot_details.workplace.state_province}} {{reservation.timeslot_details.workplace.postal_code}}
              </td>
              <td>
                {{reservation.timeslot_details.getStartTime()}} à {{reservation.timeslot_details.getEndTime()}}
              </td>
              <td>
                4
              </td>
              <td>
                <a (click)="askToCancelReservation(reservation)">
                  <img src="assets/images/icons/icon_exit.svg"
                       alt="Annuler"
                       class="profile-page__content__right__blocs__table__body__icon"/>
                </a>
              </td>
            </tr>
          </tbody>
        </table>
        <a class="profile-page__content__right__blocs__action" routerLink="/reservation/{{listWorkplaces[0].id}}" *ngIf="listWorkplaces">
          <img src="../../../../assets/images/icons/icon_plus.svg" class="profile-page__content__right__blocs__action__icon"/> Ajouter des blocs de rédaction
        </a>
        <a *ngIf="!displayAll" class="profile-page__content__right__blocs__link nt-link" (click)="setDisplayAll(true)">Afficher mes anciens blocs de rédaction</a>
        <a *ngIf="displayAll" class="profile-page__content__right__blocs__link nt-link" (click)="setDisplayAll(false)">Cacher mes anciens blocs de rédaction</a>
      </div>
    </div>
  </div>
</div>

<app-nt-modal name="form_deactivate_account"
              typeModal="danger"
              title="Désactiver mon profil"
              button2Label="Désactiver"
              (button2)="deactivateAccount()"
              maxWidth="600px">
  <p>
    La désactivation de votre profil est un acte important et irréversible.
  </p>
  <p>
    Êtes-vous vraiment sûr de vouloir désactiver votre profil ?
  </p>
</app-nt-modal>

<app-nt-modal name="form_cancel_reservation"
              typeModal="danger"
              title="Annuler ma réservation"
              button2Label="Annuler ma réservation"
              (button2)="cancelReservation()"
              maxWidth="600px"
              [autoClose]="true">
  <p>
    L'annulation de votre réservation est un acte important et irréversible, de plus, vous ne recevrez aucun remboursement.
  </p>
  <p>
    Êtes-vous vraiment sûr de vouloir annuler votre réservation ?
  </p>
</app-nt-modal>
